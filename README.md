

# Statistics Processing
A gRPC service to calculate summary statistics from financial transactions.

This service is running in a GKE instance on Google Cloud Platform and can be accessed at `35.239.102.102:50050`

## API Definition
As defined by the proto file in `server/protos/proto`, this API expects to receive a document with financial transactions in **bytes**. The return is the frequency count of each category in the columns. Ex:

```
,CompanyId,ColumnName,ColumnValue,Count
0,int:a055470,AccountTypeName,Balance,25
1,int:a055470,AccountTypeName,Profit and Loss,75
...
```

More examples are available in `server/test`.

### Parameters
The request can be customized in the following way:
- **cols_exclude**: List of column names that should not be summarized. (default: `[]`)
- **max_unique_perc**: Maximum percentual of unique values in a column. For example, if this value is set **0.5**, any column that count(unique values)/count(values) is greater than **0.5** will not be summarized. (default: `0.6`)
- **input_delimiter**: The delimiter of the input document sent to the API. (default: `,`) 
- **summary_header**: The header of the output generated by the API. (default: `,CompanyId,ColumnName,ColumnValue,Count\n`)
- **key_column**: Column to use as key for aggregation. (default: `CompanyId`)

More information about the parameters is available in the proto file, and the definition of the defaults is in `server/server.toml`.


## Getting Started

This project requires Docker to be installed and a Python working setup for testing and development.

### Quickstart

Running it then should be as simple as:

```console
$ make build
$ make run
```

### Testing

```console
$ pip install -r requirements.txt
$ make generate-proto
$ make test
```

## Deploy
This repository is configured with a GitHub Actions workflow that will execute the tests, build the docker image, and deploy to the Kubernetes cluster hosted on Google Cloud Platform.

## Monitoring
The Kubernetes cluster has both Prometheus and Grafana services. This project is configured to send the server-side metrics to Prometheus. In addition, the cluster overall health can be visualized in some [dashboards](http://35.223.137.117:80) already created in Grafana.

## Scaling
The GKE instance is configured with autoscale for nodes and pods. However, the gRPC service was deployed with Kubernetes's default load balancing. In order to better scale the service, other strategies should be considered. One example is to make the gRPC load balancing with [Linkerd](https://linkerd.io/). This strategy is documented in the Kubernetes blog: https://kubernetes.io/blog/2018/11/07/grpc-load-balancing-on-kubernetes-without-tears/

## Future Improvements
- This project uses standard gRPC  docker images for building and running in production. Those images are currently large and may affect the use of resources during development and production.
- As mentioned in the Scaling part, the load balancing strategy can be reviewed.
## References

[Cookiecutter template](https://github.com/lieutdan13/cookiecutter-grpc-python)